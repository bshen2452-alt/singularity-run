<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‡é»ç«¶é€Ÿ v11.0 - è²¡å‹™ç³»çµ±èª¿æ•´</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-tertiary:#1a1a25;--bg-card:rgba(20,20,30,0.85);--accent-cyan:#00f5ff;--accent-magenta:#ff00aa;--accent-yellow:#ffd000;--accent-green:#00ff88;--accent-red:#ff3366;--accent-orange:#ff6600;--accent-purple:#aa44ff;--text-primary:#e8e8f0;--text-secondary:#a0a0b0;--text-muted:#606075;--border-color:rgba(0,245,255,0.2);--glow-cyan:0 0 20px rgba(0,245,255,0.4);--font-display:'Orbitron',sans-serif;--font-body:'Rajdhani',sans-serif;--font-mono:'Share Tech Mono',monospace}
        body{font-family:var(--font-body);background:var(--bg-primary);color:var(--text-primary);min-height:100vh}
        body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(0,245,255,0.08)0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(255,0,170,0.08)0%,transparent 50%);pointer-events:none;z-index:-1}
        ::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--bg-secondary)}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--accent-cyan),var(--accent-magenta));border-radius:4px}
        @keyframes pulse-glow{0%,100%{opacity:1}50%{opacity:0.5}}
        @keyframes slide-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- 1. é…ç½®æ–‡ä»¶ -->
    <script src="config.js"></script>
    <script src="global_market_config.js"></script>
    <script src="region_config.js"></script>
    <script src="data_config.js"></script>
    <script src="energy_config.js"></script>
    <script src="space_config.js"></script>
    <script src="compute_config.js"></script>
    <script src="products_config.js"></script>
    <script src="community_config.js"></script>
    <script src="marketing_config.js"></script>
    <script src="etf_config.js"></script>
    <script src="credit_config.js"></script>
    <script src="strategy_blueprint_config.js"></script>
    <script src="route_skill_config.js"></script>
    <script src="asset_card_config.js"></script>
    <script src="facility_upgrade_products_config.js"></script>
    <script src="energy_products_config.js"></script>
    <script src="ending_config.js"></script>

    <!-- 2. æ ¸å¿ƒå¼•æ“æ–‡ä»¶ -->
    <script src="executeRivalInvestment_engine.js"></script>
    <script src="global_market_engine.js"></script>
    <script src="region_engine.js"></script>
    <script src="data_engine.js"></script>
    <script src="asset_card_engine.js"></script>
    <script src="facility_upgrade_engine.js"></script>
    <script src="facility_upgrade_integration.js"></script>
    <script src="energy_price_engine.js"></script>
    <script src="InitialState_engine.js"></script>
    <script src="space_engine.js"></script>
    <script src="strategy_blueprint_engine.js"></script>
    <script src="strategy_blueprint_integration.js"></script>
    <script src="route_skill_engine.js"></script>
    <script src="space_efficiency_debuff.js"></script>
    <script src="space_construction_patch.js"></script>
    <script src="event_engine.js"></script>
    <script src="ending_engine.js"></script>
    <script src="products_engine.js"></script>
    <script src="marketing_engine.js"></script>
    <script src="community_engine.js"></script>
    <script src="game_handleTurn_engine.js"></script>
    <script src="game_handleEndTurn_engine.js"></script>
    <script src="compute_engine.js"></script>
    <script src="processTurnUpdates_engine.js"></script>
    <script src="turn_update_space_patch.js"></script>
    <script src="executeAssetAction_engine.js"></script>
    <script src="executeMilestoneLaunch_engine.js"></script>
    <script src="products_integration.js"></script>
    <script src="products_operating_fix.js"></script>
    <script src="mastery_experience_fix.js"></script>
    <script src="product_line_upgrade_engine.js"></script>
    <!-- åœ¨ space_engine.js ä¹‹å¾Œ -->
    <script src="space_facility_tech_ext.js"></script>
    <script src="processTurnUpdates_facility_tech.js"></script>
    <script src="executeStrategy_engine.js"></script>
    <script src="executeFinance_engine.js"></script>
    <script src="etf_engine.js"></script>
    <script src="market_perturbation_engine.js"></script>
    <script src="credit_engine.js"></script>
    <script src="dashboard_engine.js"></script>
    <script src="state_migration_engine.js"></script>


    <!-- 3. ç»Ÿä¸€å¼•æ“æ¥å£ï¼ˆåœ¨æ‰€æœ‰å­å¼•æ“åŠ è½½åï¼‰ -->
    <script src="engine.js"></script>
    <script src="useGameState.js"></script>

    <!-- 3.5 æ•ˆç‡æ•´åˆè£œä¸ï¼ˆå·²åŒ…å«ç©ºé–“æ•ˆç‡+ç®—åŠ›ä½¿ç”¨ç‡ï¼‰-->
    <script src="useGameState_efficiency_patch.js"></script>
    <!-- 4. è³‡æ–™æ–‡ä»¶ï¼ˆå…¼å®¹èˆŠç³»çµ±æ¥å£ + è‡ªå‹•è£œä¸ï¼‰ -->
    <script src="data_system_patch.js"></script>

    
    <!-- 4. React ç»„ä»¶ -->
    <script type="text/babel" src="ui_products.jsx"></script>
    <script type="text/babel" src="ui_space.jsx"></script>
    <script type="text/babel" src="ui_assets.jsx"></script>
    <script type="text/babel" src="ui_asset_cards.jsx"></script>
    <script type="text/babel" src="ui_facility_upgrade.jsx"></script>
    <script type="text/babel" src="ui_organization.jsx"></script>
    <script type="text/babel" src="ui_community.jsx"></script>
    <script type="text/babel" src="ui_rivals.jsx"></script>
    <script type="text/babel" src="./Components.jsx"></script>
    <script type="text/babel" src="ui_blueprint.jsx"></script>
    <script type="text/babel" src="ui_route_skill.jsx"></script>
    <script type="text/babel" src="ui_facility_tech.jsx"></script>
    <script type="text/babel" src="ui_region.jsx"></script>
    <script type="text/babel" src="ui_dashboard.jsx"></script>
    <script type="text/babel" src="utils.js"></script>
    <script type="text/babel" src="./GameUI.jsx"></script>  
    <script type="text/babel">
// ============================================
// å¥‡é»ç«¶é€Ÿ - React éŠæˆ²ä»‹é¢ (ç´”è¦–è¦ºåŒ–å±¤)
// ============================================

const { useState, useEffect, useCallback, useMemo, useRef } = React;

// ============================================
// å·¥å…·å‡½æ•¸ (å¾ Utils å°å…¥)
// ============================================

// ä½¿ç”¨å…¨å±€ Utils å°è±¡
const { 
    formatNumber,
    getStatusColor,
    getDoomColor,
    getDoomLabelInfo,
    getMessageTypeColors,
    getDialogTypeColors,
    getDialogIcon,
    calculatePercentage,
    getModalSize,
    useLocalStorage 
} = window.Utils || {};

// ============================================
// UI çµ„ä»¶ (å¾ Components å°å…¥)
// ============================================

// ä½¿ç”¨å…¨å±€ Components å°è±¡
const {
    GlowButton,
    Panel,
    ProgressBar,
    MessageLog,
    Modal,
    Input,
    SelectCard,
    Tabs,
    ConfirmDialog
} = window.Components || {};

// ============================================
// è‡ªå®šç¾© UI çµ„ä»¶ (å°ˆå±¬æ–¼éŠæˆ²ä»‹é¢)
// ============================================

// æ•¸å€¼é¡¯ç¤ºçµ„ä»¶
function StatValue({ label, value, icon, color = 'var(--accent-cyan)', suffix = '', prefix = '' }) {
    return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '1px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                {icon && <span>{icon}</span>}
                {label}
            </div>
            <div style={{ fontSize: '1.5rem', fontFamily: 'var(--font-mono)', fontWeight: 700, color: color, textShadow: `0 0 20px ${color}44`, display: 'flex', alignItems: 'baseline', gap: '4px' }}>
                <span style={{ fontSize: '1rem', opacity: 0.7 }}>{prefix}</span>
                {typeof value === 'number' ? formatNumber(value) : value}
                <span style={{ fontSize: '0.9rem', opacity: 0.7 }}>{suffix}</span>
            </div>
        </div>
    );
}



// åŠŸèƒ½è§£é–é€šçŸ¥çµ„ä»¶
function UnlockNotification({ tier, onClose }) {
    const config = TIER_UNLOCK_CONFIG[tier];
    if (!config) return null;
    const [offset, setOffset] = React.useState({ x: 0, y: 0 });
    const [dragging, setDragging] = React.useState(false);
    const [dragStart, setDragStart] = React.useState({ x: 0, y: 0 });

    const handleMouseDown = (e) => {
        setDragging(true);
        setDragStart({ x: e.clientX - offset.x, y: e.clientY - offset.y });
    };

    React.useEffect(() => {
        if (!dragging) return;
        const handleMouseMove = (e) => {
            setOffset({ x: e.clientX - dragStart.x, y: e.clientY - dragStart.y });
        };
        const handleMouseUp = () => setDragging(false);
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
    }, [dragging, dragStart]);
    
    return (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0, 0, 0, 0.9)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1001, backdropFilter: 'blur(10px)', animation: 'slide-in 0.3s ease-out' }}>
            <div style={{ background: 'var(--bg-secondary)', border: `2px solid ${config.color}`, borderRadius: '16px', width: '500px', maxWidth: '95vw', overflow: 'hidden', boxShadow: `0 0 60px ${config.color}44, 0 20px 60px rgba(0, 0, 0, 0.5)`, transform: `translate(${offset.x}px, ${offset.y}px)`, cursor: dragging ? 'grabbing' : 'grab', transition: dragging ? 'none' : 'transform 0.2s ease-out' }}>
                {/* æ¨™é¡Œå€ */}
                <div onMouseDown={handleMouseDown} style={{ background: `linear-gradient(135deg, ${config.color}33, transparent)`, padding: '24px', textAlign: 'center', borderBottom: `1px solid ${config.color}44`, cursor: 'grab', userSelect: 'none' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '12px', animation: 'pulse-glow 2s infinite' }}>{config.icon}</div>
                    <h2 style={{ fontFamily: 'var(--font-display)', fontSize: '1.3rem', color: config.color, textTransform: 'uppercase', letterSpacing: '3px', margin: 0 }}>
                        ğŸ‰ æ–°åŠŸèƒ½è§£é–ï¼
                    </h2>
                    <h3 style={{ fontFamily: 'var(--font-display)', fontSize: '1rem', color: 'var(--text-primary)', marginTop: '8px' }}>
                        {config.title}
                    </h3>
                </div>
                
                {/* åŠŸèƒ½åˆ—è¡¨ */}
                <div style={{ padding: '20px' }}>
                    {config.features.map((feature, idx) => (
                        <div key={idx} style={{ display: 'flex', alignItems: 'flex-start', gap: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', marginBottom: '8px', border: `1px solid ${config.color}22` }}>
                            <span style={{ fontSize: '1.5rem' }}>{feature.icon}</span>
                            <div>
                                <div style={{ fontWeight: 600, color: config.color, marginBottom: '4px' }}>{feature.name}</div>
                                <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>{feature.desc}</div>
                            </div>
                        </div>
                    ))}
                    
                    {config.futureHint && (
                        <div style={{ marginTop: '16px', padding: '12px', background: 'var(--bg-primary)', borderRadius: '8px', fontSize: '0.8rem', color: 'var(--text-muted)', fontStyle: 'italic', borderLeft: `3px solid ${config.color}44` }}>
                            ğŸ”® {config.futureHint}
                        </div>
                    )}
                </div>
                
                {/* æŒ‰éˆ• */}
                <div style={{ padding: '16px 20px', borderTop: '1px solid var(--border-color)', textAlign: 'center' }}>
                    <GlowButton variant="primary" onClick={onClose} icon="âœ¨">
                        é–‹å§‹æ¢ç´¢æ–°åŠŸèƒ½
                    </GlowButton>
                </div>
            </div>
        </div>
    );
}


// ============================================
// éŠæˆ²ç•«é¢çµ„ä»¶
// ============================================

function StartScreen({ onStart }) {
    const [companyName, setCompanyName] = useState('');
    const [selectedRoute, setSelectedRoute] = useState(null);
    const [rivalCount, setRivalCount] = useState(3);
    const routes = GameConfig.TECH_ROUTES;
    const canStart = companyName.trim() && selectedRoute;

    return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '40px 20px', position: 'relative' }}>
            <div style={{ textAlign: 'center', marginBottom: '48px' }}>
                <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 'clamp(2rem, 5vw, 4rem)', fontWeight: 900, background: 'linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta))', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '8px', textShadow: '0 0 40px rgba(0, 245, 255, 0.3)', letterSpacing: '4px' }}>å¥‡é»ç«¶é€Ÿ</h1>
                <h2 style={{ fontFamily: 'var(--font-display)', fontSize: 'clamp(0.8rem, 2vw, 1.2rem)', color: 'var(--text-secondary)', letterSpacing: '8px', textTransform: 'uppercase', marginBottom: '16px' }}>The Singularity Run</h2>
                <p style={{ color: 'var(--text-muted)', maxWidth: '600px', margin: '0 auto', lineHeight: 1.6 }}>åœ¨ AI ç«¶è³½ä¸­ç”Ÿå­˜ã€‚å¹³è¡¡ç ”ç™¼é€²åº¦ã€è²¡å‹™ç‹€æ³èˆ‡é¢¨éšªç®¡ç†ã€‚<br />é–‹ç™¼ AGI æŠµé”å¥‡é»â€”â€”æˆ–åœ¨æ­¤ä¹‹å‰è¢«æ·˜æ±°ã€‚</p>
            </div>
            <div style={{ width: '100%', maxWidth: '800px', background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '16px', padding: '32px', backdropFilter: 'blur(10px)' }}>
                <Input label="å…¬å¸åç¨±" value={companyName} onChange={setCompanyName} placeholder="è¼¸å…¥ä½ çš„ AI å…¬å¸åç¨±..." icon="ğŸ¢" />
                <div style={{ marginTop: '24px' }}>
                    <label style={{ display: 'block', marginBottom: '12px', fontSize: '0.85rem', color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: '1px' }}>ğŸ¯ é¸æ“‡æ ¸å¿ƒå•†æ¥­æ¨¡å¼</label>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '12px' }}>
                        {Object.entries(routes).map(([key, route]) => (
                            <SelectCard key={key} selected={selectedRoute === key} onClick={() => setSelectedRoute(key)} title={route.name} description={route.description} icon={route.icon} color={route.color} />
                        ))}
                    </div>
                </div>
                {/* å°æ‰‹æ•¸é‡é¸æ“‡ */}
                <div style={{ marginTop: '24px' }}>
                    <label style={{ display: 'block', marginBottom: '12px', fontSize: '0.85rem', color: 'var(--text-secondary)', textTransform: 'uppercase', letterSpacing: '1px' }}>ğŸ¢ ç«¶çˆ­å°æ‰‹æ•¸é‡ (1-6)</label>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <input type="range" min="1" max="6" value={rivalCount} onChange={(e) => setRivalCount(parseInt(e.target.value))}
                            style={{ flex: 1, accentColor: 'var(--accent-cyan)' }} />
                        <span style={{ fontFamily: 'var(--font-mono)', fontSize: '1.5rem', color: 'var(--accent-cyan)', minWidth: '40px', textAlign: 'center' }}>{rivalCount}</span>
                    </div>
                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '8px' }}>
                        å°æ‰‹å°‡å¾ä½ æœªé¸æ“‡çš„æŠ€è¡“è·¯ç·šä¸­éš¨æ©Ÿç”¢ç”Ÿï¼Œæ¯ä½å°æ‰‹ä½¿ç”¨ä¸åŒè·¯ç·š
                    </div>
                </div>
                <div style={{ marginTop: '32px', textAlign: 'center' }}>
                    <GlowButton variant="primary" size="large" onClick={() => onStart(companyName, selectedRoute, rivalCount)} disabled={!canStart} icon="ğŸš€">é–‹å§‹ç«¶è³½</GlowButton>
                </div>
            </div>
            <div style={{ position: 'absolute', bottom: '20px', color: 'var(--text-muted)', fontSize: '0.75rem', fontFamily: 'var(--font-mono)' }}>v11.0 Web Edition</div>
        </div>
    );
}

function TopStatusBar({ player, derived, globalParams, route }) {
    // å®‰å…¨è®€å–globalParamsï¼Œé˜²æ­¢undefinedå°è‡´NaN
    const safeGlobalParams = {
        P_GPU: globalParams?.P_GPU ?? 1.0,
        E_Price: globalParams?.E_Price ?? 1.0,
        R_base: globalParams?.R_base ?? 1.0,
        I_Hype: globalParams?.I_Hype ?? 1.0
    };
    return (
        <div style={{ background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '16px 24px', display: 'flex', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'space-between', gap: '16px', backdropFilter: 'blur(10px)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                <div style={{ width: '48px', height: '48px', borderRadius: '12px', background: `linear-gradient(135deg, ${route.color}44, ${route.color}22)`, border: `2px solid ${route.color}`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem' }}>{route.icon}</div>
                <div>
                    <h2 style={{ fontFamily: 'var(--font-display)', fontSize: '1.2rem', color: 'var(--text-primary)', margin: 0 }}>{player.name}</h2>
                    <div style={{ fontSize: '0.8rem', color: route.color, fontFamily: 'var(--font-mono)' }}>{route.name}</div>
                </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
                <div style={{ textAlign: 'center', padding: '8px 16px', background: 'var(--bg-tertiary)', borderRadius: '8px' }}>
                    <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase' }}>å­£åº¦</div>
                    <div style={{ fontFamily: 'var(--font-display)', fontSize: '1.5rem', color: 'var(--accent-cyan)' }}>Q{player.turn_count}</div>
                </div>
                <div style={{ display: 'flex', gap: '12px', fontSize: '0.8rem' }}>
                    <div style={{ color: 'var(--text-secondary)' }}>åˆ©ç‡ <span style={{ color: safeGlobalParams.R_base > 1 ? 'var(--accent-red)' : 'var(--accent-green)', fontFamily: 'var(--font-mono)' }}>{safeGlobalParams.R_base.toFixed(2).replace(/\.?0+$/, '')}x</span></div>
                    <div style={{ color: 'var(--text-secondary)' }}>GPU <span style={{ color: safeGlobalParams.P_GPU > 1 ? 'var(--accent-red)' : 'var(--accent-green)', fontFamily: 'var(--font-mono)' }}>{safeGlobalParams.P_GPU.toFixed(2).replace(/\.?0+$/, '')}x</span></div>
                    <div style={{ color: 'var(--text-secondary)' }}>Hype <span style={{ color: 'var(--accent-cyan)', fontFamily: 'var(--font-mono)' }}>{safeGlobalParams.I_Hype.toFixed(2).replace(/\.?0+$/, '')}x</span></div>
                    <div style={{ color: 'var(--text-secondary)' }}>èƒ½æº <span style={{ color: safeGlobalParams.E_Price > 1 ? 'var(--accent-red)' : 'var(--accent-green)', fontFamily: 'var(--font-mono)' }}>{safeGlobalParams.E_Price.toFixed(2).replace(/\.?0+$/, '')}x</span></div>
                </div>
            </div>
        </div>
    );
}




// æˆ°ç•¥è¡Œå‹•é¢æ¿
function StrategyActions({ gameState, derived, onAction, usedActions = {} }) {
    console.log("StrategyActions loaded");
    const { player } = gameState;
    const route = GameConfig.TECH_ROUTES[player.route];
    
    // æª¢æŸ¥å¯ç™¼å¸ƒçš„é‡Œç¨‹ç¢‘
    const launchableMilestones = (() => {   
        const result = [];
        const MODEL_TIERS = GameConfig.COSTS.MODEL_TIERS;
        for (let tier = 1; tier <= 5; tier++) { 
            // è·³éå·²å®Œæˆçš„é‡Œç¨‹ç¢‘          
            if (player.mp_milestones?.[tier]) continue; 
            // æª¢æŸ¥å‰ç½®é‡Œç¨‹ç¢‘ï¼ˆtier > 1 éœ€è¦å®Œæˆå‰ä¸€å€‹ï¼‰
            if (tier > 1 && !player.mp_milestones?.[tier - 1]) continue; 
            // æª¢æŸ¥ MP æ˜¯å¦é”åˆ°é–€æª»
            const tierData = MODEL_TIERS[tier];
            if (tierData && player.model_power < tierData.mp) continue; 
                result.push(tier);
        }
        return result;
    })();
    
    // è¨ˆç®—ä¸‹ä¸€å€‹é‡Œç¨‹ç¢‘ç›®æ¨™
    const nextMilestoneData = (() => {
        for (let tier = 1; tier <= 5; tier++) {
            if (!player.mp_milestones?.[tier]) {
                const tierData = GameConfig.COSTS.MODEL_TIERS[tier];
                return { tier, data: tierData, mpNeeded: tierData.mp, mpCurrent: player.model_power };
            }
        }
        return null;
    })();
    
    // æª¢æŸ¥æ˜¯å¦æœ¬å­£å·²åŸ·è¡Œæ ¸å¿ƒæˆ°ç•¥
    const coreActionUsed = usedActions.research || usedActions.alignment || usedActions.marketing || usedActions.special;
    
    // è·¯ç·šæŠ€èƒ½è™•ç†å‡½æ•¸
    const handleRouteSkill = (skillId, skillType) => {
        onAction('routeSkill', { skillId, skillType });
    };

    return (
        <div style={{ display: 'grid', gap: '12px' }}>
            {/* æ ¸å¿ƒæˆ°ç•¥å€å¡Š */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                <h4 style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>æ ¸å¿ƒæˆ°ç•¥ (æ¯å­£é™é¸ä¸€é …)</h4>
                {coreActionUsed && <span style={{ fontSize: '0.75rem', color: 'var(--accent-green)', padding: '4px 8px', background: 'var(--accent-green)22', borderRadius: '4px' }}>âœ“ æœ¬å­£å·²åŸ·è¡Œ</span>}
            </div>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '12px' }}>
                <div style={{ padding: '12px', background: usedActions.research ? 'var(--accent-cyan)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${usedActions.research ? 'var(--accent-cyan)' : 'var(--accent-cyan)33'}` }}>
                    <GlowButton variant="primary" onClick={() => onAction('research')} icon="ğŸ”¬" disabled={coreActionUsed} style={{ width: '100%', marginBottom: '8px' }}>å…¨åŠ›ç ”ç™¼</GlowButton>
                    <div style={{ fontSize: '0.75rem', color: derived.active_pflops <= 0 ? 'var(--accent-red)' : 'var(--text-muted)' }}>{derived.active_pflops <= 0 ? 'âš ï¸ ç®—åŠ›ä¸è¶³' : 'MP â†‘â†‘ | ç†µå€¼ â†‘â†‘'}
                </div>
                </div>
                <div style={{ padding: '12px', background: usedActions.alignment ? 'var(--accent-green)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${usedActions.alignment ? 'var(--accent-green)' : 'var(--accent-green)33'}` }}>
                    <GlowButton variant="success" onClick={() => onAction('alignment')} icon="ğŸ›¡ï¸" disabled={coreActionUsed} style={{ width: '100%', marginBottom: '8px' }}>å®‰å…¨å°é½Š</GlowButton>
                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>å°é½Šåº¦ â†‘ | ç†µå€¼ â†“â†“</div>
                </div>
                <div style={{ padding: '12px', background: usedActions.marketing ? 'var(--accent-yellow)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${usedActions.marketing ? 'var(--accent-yellow)' : 'var(--accent-yellow)33'}` }}>
                    <GlowButton variant="warning" onClick={() => onAction('marketing')} icon="ğŸ“£" disabled={coreActionUsed} style={{ width: '100%', marginBottom: '8px' }}>å¸‚å ´ç‡ŸéŠ·</GlowButton>
                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>Hype â†‘â†‘ | Trust â†‘</div>
                </div>
            </div>


            
            {/* é‡Œç¨‹ç¢‘ç™¼å¸ƒæº–å‚™å®Œæˆ */}
            {launchableMilestones.length > 0 && (
                <div style={{ marginTop: '16px', padding: '16px', background: 'var(--accent-magenta)11', borderRadius: '8px', border: '1px solid var(--accent-magenta)33' }}>
                    <h4 style={{ color: 'var(--accent-magenta)', fontSize: '0.9rem', marginBottom: '12px' }}>ğŸ¯ é‡Œç¨‹ç¢‘ç™¼å¸ƒæº–å‚™å®Œæˆ</h4>
                    <div style={{ display: 'grid', gap: '12px' }}>
                        {launchableMilestones.map(tier => {
                            const data = GameConfig.COSTS.MODEL_TIERS[tier];
                            const failCount = player.milestone_fail_count?.[tier] || 0;
                            const costMult = 1 + failCount * 0.5;
                            const totalCost = 100 * costMult;
                            return (
                                <div key={tier} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '6px', border: '1px solid var(--accent-magenta)44' }}>
                                    <div>
                                        <div style={{ fontWeight: 600, color: 'var(--text-primary)' }}>{data.name}</div>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginTop: '4px' }}>
                                            ğŸ’° ç™¼èµ·æˆæœ¬ï¼š${totalCost}M {failCount > 0 && `(+${failCount}æ¬¡å¤±æ•—)`}
                                        </div>
                                    </div>
                                    <GlowButton 
                                        variant="secondary" 
                                        size="small"
                                        onClick={() => onAction('milestone', { tier })}
                                    >
                                        ç™¼å¸ƒ
                                    </GlowButton>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}
            
            {/* ä¸‹ä¸€éšæ®µç›®æ¨™ */}
            {nextMilestoneData && (
                <div style={{ marginTop: '16px', padding: '16px', background: 'var(--accent-cyan)11', borderRadius: '8px', border: '1px solid var(--accent-cyan)33' }}>
                    <h4 style={{ color: 'var(--accent-cyan)', fontSize: '0.9rem', marginBottom: '12px' }}>ğŸ¯ ä¸‹ä¸€éšæ®µç›®æ¨™</h4>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <div style={{ fontWeight: 600, color: 'var(--text-primary)' }}>{nextMilestoneData.data.name}</div>
                            <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginTop: '6px', display: 'grid', gap: '4px' }}>
                                <span>ğŸ“Š éœ€è¦ MP: {nextMilestoneData.mpNeeded}</span>
                                <span style={{ color: nextMilestoneData.mpCurrent >= nextMilestoneData.mpNeeded ? 'var(--accent-green)' : 'var(--accent-yellow)' }}>
                                    â³ é‚„å·®: {Math.max(0, nextMilestoneData.mpNeeded - nextMilestoneData.mpCurrent).toFixed(1)} MP
                                </span>
                            </div>
                        </div>
                        <div style={{ textAlign: 'right', fontSize: '1.8rem', opacity: 0.3 }}>
                            {Math.max(0, nextMilestoneData.mpNeeded - nextMilestoneData.mpCurrent) === 0 ? 'âœ“' : 'â†’'}
                        </div>
                    </div>
                </div>
            )}

            {/* è·¯ç·šå°ˆå±¬æŠ€èƒ½æ¬„ä½ - ç¨ç«‹å†·å» */}
            {window.RouteSkillPanel && (
                <RouteSkillPanel 
                    player={player}
                    route={route}
                    onUseSkill={handleRouteSkill}
                />
            )}

            {/* ç®—åŠ›åˆ†é…ç­–ç•¥ */}
            {player.mp_tier >= 1 && (
                <div style={{ display: 'grid', gap: '12px', marginTop: '16px' }}>
                    <h4 style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginBottom: '8px' }}>ç®—åŠ›åˆ†é…ç­–ç•¥</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '12px' }}>
                        <div style={{ padding: '12px', background: player.product_state.compute_strategy === 'ResearchFocus' ? 'var(--accent-cyan)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${player.product_state.compute_strategy === 'ResearchFocus' ? 'var(--accent-cyan)' : 'var(--accent-cyan)33'}`, opacity: player.product_state.compute_strategy && player.product_state.compute_strategy !== 'ResearchFocus' ? 0.5 : 1 }}>
                            <GlowButton variant="primary" onClick={() => onAction('setComputeStrategy', { strategy: 'ResearchFocus' })} icon="ğŸ”¬" style={{ width: '100%', marginBottom: '8px' }}>ç ”ç™¼å„ªå…ˆ</GlowButton>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>ç¶­æŒæ¨¡å‹è¨“ç·´ç®—åŠ›ï¼ŒçŠ§ç‰²ç”¢å“æœå‹™å“è³ª</div>
                        </div>
                        <div style={{ padding: '12px', background: player.product_state.compute_strategy === 'ProductFocus' ? 'var(--accent-green)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${player.product_state.compute_strategy === 'ProductFocus' ? 'var(--accent-green)' : 'var(--accent-green)33'}`, opacity: player.product_state.compute_strategy && player.product_state.compute_strategy !== 'ProductFocus' ? 0.5 : 1 }}>
                            <GlowButton variant="success" onClick={() => onAction('setComputeStrategy', { strategy: 'ProductFocus' })} icon="ğŸ“¦" style={{ width: '100%', marginBottom: '8px' }}>ç”¢å“å„ªå…ˆ</GlowButton>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>ä¿éšœç”¢å“æœå‹™ï¼Œé™ä½ç ”ç™¼é€Ÿåº¦</div>
                        </div>
                        <div style={{ padding: '12px', background: player.product_state.compute_strategy === 'Balanced' ? 'var(--accent-yellow)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${player.product_state.compute_strategy === 'Balanced' ? 'var(--accent-yellow)' : 'var(--accent-yellow)33'}`, opacity: player.product_state.compute_strategy && player.product_state.compute_strategy !== 'Balanced' ? 0.5 : 1 }}>
                            <GlowButton variant="warning" onClick={() => onAction('setComputeStrategy', { strategy: 'Balanced' })} icon="âš–ï¸" style={{ width: '100%', marginBottom: '8px' }}>å¹³è¡¡ç™¼å±•</GlowButton>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>å‡è¡¡åˆ†é…ç®—åŠ›è³‡æº</div>
                        </div>
                        <div style={{ padding: '12px', background: player.product_state.compute_strategy === 'CloudBursting' ? 'var(--accent-magenta)22' : 'var(--bg-tertiary)', borderRadius: '8px', border: `1px solid ${player.product_state.compute_strategy === 'CloudBursting' ? 'var(--accent-magenta)' : 'var(--accent-magenta)33'}`, opacity: player.product_state.compute_strategy && player.product_state.compute_strategy !== 'CloudBursting' ? 0.5 : 1 }}>
                            <GlowButton variant="secondary" onClick={() => onAction('setComputeStrategy', { strategy: 'CloudBursting' })} icon="â˜ï¸" style={{ width: '100%', marginBottom: '8px' }}>è‡ªå‹•é›²ç«¯</GlowButton>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>è‡ªå‹•ç§Ÿç”¨é›²ç«¯ç®—åŠ›æ»¿è¶³éœ€æ±‚ï¼Œæˆæœ¬è¼ƒé«˜</div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* ç¤¾ç¾¤æˆ°ç•¥é¢æ¿ - åœ¨ç®—åŠ›åˆ†é…ç­–ç•¥ä¸‹æ–¹ */}
                {player.mp_tier >= 1 && window.CommunityUI && (
                    React.createElement(window.CommunityUI.CommunityStrategyPanel, {
                        player: player,
                        onSelectStrategy: (strategyId) => onAction('communityStrategy', { strategyId }),
                        disabled: false,
                        selectedStrategy: player.selected_community_strategy
                    })
                )}

            {/* å•†å“é–‹ç™¼é€²åº¦æ¢ */}
            {player.mp_tier >= 1 && player.product_state?.developing?.length > 0 && (
                <div style={{ marginTop: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', border: '1px solid var(--border-color)' }}>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text-secondary)', marginBottom: '8px' }}>ğŸ“‹ é–‹ç™¼ä¸­å•†å“ ({player.product_state.developing.length})</div>
                    {player.product_state.developing.map((dev) => (
                        <div key={dev.id} style={{ marginBottom: '6px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', marginBottom: '2px' }}>
                                <span style={{ color: 'var(--text-primary)' }}>{dev.name}</span>
                                <span style={{ color: 'var(--accent-cyan)' }}>{dev.progress.toFixed(0)}%</span>
                            </div>
                            <ProgressBar value={dev.progress} max={100} color="var(--accent-cyan)" height={4} showLabel={false} />
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}


// è²¡å‹™è¡Œå‹•é¢æ¿
function FinanceActions({ gameState, derived, onAction }) {
    const { player } = gameState;
    const [amount, setAmount] = useState(100);
    const [repayAmount, setRepayAmount] = useState(100);
    
    // å¾ GameConfig ç²å–æ‰€æœ‰å¯ç”¨çš„è²¡å‹™è¡Œå‹•
    const getAvailableActions = () => {
        const actions = [];
        const tier = player.mp_tier || 0;
        const FA = GameConfig.FINANCE_ACTIONS;

        // Tier 0 è¡Œå‹• (èµ·å§‹å¯ç”¨)
        Object.values(FA.tier0 || {}).forEach(action => {
            actions.push({ ...action, available: true, tierLabel: 'èµ·å§‹' });
        });

        // Tier 1 è¡Œå‹• (å‚µåˆ¸é¡)
        Object.values(FA.tier1 || {}).forEach(action => {
            actions.push({ ...action, available: tier >= 1, tierLabel: 'Tier 1' });
        });

        // Tier 2 è¡Œå‹• (è‚¡ç¥¨é¡)
        Object.values(FA.tier2 || {}).forEach(action => {
            const isIPODone = player.is_public || false;
            let available = tier >= 2;
            if (action.requiresIPO && !isIPODone) {
                available = false;
            }
            if (action.oneTime && isIPODone) {
                available = false;
            }
            actions.push({ ...action, available, tierLabel: 'Tier 2', isIPODone });
        });

        // Tier 3 è¡Œå‹• (å•†æ¥­åŠŸèƒ½)
        Object.values(FA.tier3 || {}).forEach(action => {
            actions.push({ ...action, available: tier >= 3, tierLabel: 'Tier 3' });
        });

        return actions;
    };

    const availableActions = getAvailableActions();
    
    // æ ¹æ“š tier åˆ†çµ„
    const actionsByTier = {
        èµ·å§‹: availableActions.filter(a => a.tierLabel === 'èµ·å§‹'),
        'Tier 1': availableActions.filter(a => a.tierLabel === 'Tier 1'),
        'Tier 2': availableActions.filter(a => a.tierLabel === 'Tier 2'),
        'Tier 3': availableActions.filter(a => a.tierLabel === 'Tier 3')
    };
    
    // ç²å–é¡è‰²
    const getTierColor = (tier) => {
        const colors = { 'èµ·å§‹': 'var(--accent-green)', 'Tier 1': 'var(--accent-yellow)', 'Tier 2': 'var(--accent-cyan)', 'Tier 3': 'var(--accent-magenta)' };
        return colors[tier] || 'var(--accent-cyan)';
    };
    
    return (
        <div style={{ display: 'grid', gap: '16px' }}>
            {/* è²¡å‹™è©•ç´š */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '12px' }}>
                <h4 style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>
                    è²¡å‹™è©•ç´š: <span style={{ color: 'var(--accent-yellow)' }}>{derived.finance_rating}</span>
                </h4>
                <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>
                    ç¾é‡‘: <span style={{ color: player.cash >= 0 ? 'var(--accent-green)' : 'var(--accent-red)' }}>${player.cash.toFixed(1)}M</span> | 
                    å¸‚å€¼: <span style={{ color: 'var(--accent-cyan)' }}>${player.market_cap.toFixed(0)}M</span>
                </div>
            </div>

            {/* å‚µå‹™è­¦å‘Šé¢æ¿ */}
            {player.debt > 0 && (
                <div style={{ padding: '12px 16px', background: 'var(--accent-red)22', borderRadius: '8px', border: '2px solid var(--accent-red)', display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '12px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <span style={{ fontSize: '1.2rem' }}>âš ï¸</span>
                        <div>
                            <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)' }}>ç•¶å‰å‚µå‹™</div>
                            <div style={{ fontSize: '1.1rem', fontWeight: 600, color: 'var(--accent-red)' }}>${player.debt.toFixed(1)}M</div>
                        </div>
                    </div>
                </div>
            )}
            
            {/* è²¡å‹™æ“ä½œæ¸…å–® - æŒ‰ Tier åˆ†çµ„ */}
            {Object.entries(actionsByTier).map(([tier, actions]) => 
                actions.length > 0 && (
                    <div key={tier}>
                        <div style={{ fontSize: '0.85rem', color: getTierColor(tier), fontWeight: 600, marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                            {tier === 'èµ·å§‹' ? 'ğŸŒŸ' : tier === 'Tier 1' ? 'ğŸ“Š' : tier === 'Tier 2' ? 'ğŸ“ˆ' : 'ğŸ¯'} {tier}
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '12px' }}>
                            {actions.map(action => {
                                const isLocked = !action.available;
                                const onCooldown = (player.finance_cooldowns || {})[action.id] > 0;
                                const meetsEmergencyLoanRequirement = action.id === 'emergencyLoan' 
                                    ? player.cash < (action.effects?.cash_threshold || 30) 
                                    : true;
                                const canClick = action.available && !onCooldown && meetsEmergencyLoanRequirement;
                                return (
                                    <div 
                                        key={action.id}
                                        style={{
                                            padding: '12px',
                                            background: canClick ? `${getTierColor(tier)}11` : 'var(--bg-secondary)',
                                            border: `1px solid ${canClick ? `${getTierColor(tier)}44` : 'var(--border-color)'}`,
                                            borderRadius: '8px',
                                            cursor: canClick ? 'pointer' : 'not-allowed',
                                            opacity: canClick ? 1 : 0.5,
                                            transition: 'all 0.2s ease',
                                            position: 'relative'
                                        }}
                                        onMouseEnter={(e) => canClick && (e.currentTarget.style.background = `${getTierColor(tier)}22`)}
                                        onMouseLeave={(e) => canClick && (e.currentTarget.style.background = `${getTierColor(tier)}11`)}
                                    >
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '6px' }}>
                                            <span style={{ fontSize: '1.2rem' }}>{action.icon || 'ğŸ’¼'}</span>
                                            <span style={{ color: getTierColor(tier), fontWeight: 600, flex: 1 }}>{action.name || action.id}</span>
                                            {isLocked && <span style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>ğŸ”’</span>}
                                            {onCooldown && <span style={{ fontSize: '0.75rem', color: 'var(--accent-orange)' }}>â³ {player.finance_cooldowns[action.id]}</span>}
                                        </div>
                                        <div style={{ fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '8px', minHeight: '30px' }}>
                                            {action.description || 'åŸ·è¡Œæ­¤è²¡å‹™æ“ä½œ'}
                                        </div>
                                        {action.available && (
                                            <GlowButton 
                                                variant={tier === 'èµ·å§‹' ? 'success' : tier === 'Tier 1' ? 'warning' : tier === 'Tier 2' ? 'primary' : 'secondary'}
                                                size="small" 
                                                onClick={() => onAction('financeAction', { actionId: action.id, amount: amount })}
                                                disabled={onCooldown || !meetsEmergencyLoanRequirement}
                                                style={{ width: '100%' }}
                                            >
                                                {onCooldown ? `å†·å»ä¸­ ${player.finance_cooldowns[action.id]}å­£` : !meetsEmergencyLoanRequirement && action.id === 'emergencyLoan' ? 'ç¾é‡‘å……è¶³' : 'åŸ·è¡Œ'}
                                            </GlowButton>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                )
            )}
            
            {/* å„Ÿé‚„å‚µå‹™å€ */}
            {player.debt > 0 && (
                <div style={{ marginTop: '8px', padding: '16px', background: 'var(--accent-red)11', borderRadius: '8px', border: '1px solid var(--accent-red)22' }}>
                    <h4 style={{ color: 'var(--accent-red)', fontSize: '0.9rem', marginBottom: '12px' }}>ğŸ’¸ å„Ÿé‚„å‚µå‹™ (ç•¶å‰ç¸½å‚µå‹™: ${player.debt.toFixed(1)}M)</h4>
                    <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                        <div style={{ flex: 1, minWidth: '150px' }}>
                            <Input label="å„Ÿé‚„é‡‘é¡" type="number" value={repayAmount} onChange={setRepayAmount} min={0} max={Math.min(player.cash, player.debt)} />
                        </div>
                        <GlowButton variant="success" onClick={() => onAction('repayDebt', { amount: repayAmount })} disabled={repayAmount <= 0 || player.cash < repayAmount}>
                            å„Ÿé‚„ ${repayAmount}M
                        </GlowButton>
                        <GlowButton variant="warning" onClick={() => onAction('repayDebt', { amount: Math.min(player.cash, player.debt) })} disabled={player.cash <= 0 || player.debt <= 0}>
                            å…¨éƒ¨å„Ÿé‚„
                        </GlowButton>
                    </div>
                    {player.locked_pflops > 0 && <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '8px' }}>å„Ÿé‚„å‚µå‹™å°‡è§£é–æŠµæŠ¼çš„ PFLOPS</div>}
                </div>
            )}
        </div>
    );
}

// è³‡ç”¢è¡Œå‹•é¢æ¿ - ä½¿ç”¨æ–°çš„ UI çµ„ä»¶
function AssetActions({ gameState, derived, onAction }) {
    const AssetPanel = window.AssetComponents?.AssetActionsPanel;
    if (AssetPanel) {
        return <AssetPanel gameState={gameState} derived={derived} onAction={onAction} />;
    }
    // é™ç´šè™•ç†ï¼šå¦‚æœæ–°çµ„ä»¶æœªè¼‰å…¥ï¼Œé¡¯ç¤ºæç¤º
    return <div style={{ padding: '20px', textAlign: 'center', color: 'var(--text-muted)' }}>
        è³‡ç”¢é¢æ¿è¼‰å…¥ä¸­...
    </div>;
}

// è¡Œå‹•èœå–®ä¸»çµ„ä»¶
function ActionMenu({ gameState, derived, onAction, onEndTurn, usedActions }) {
    const [activeTab, setActiveTab] = useState('strategy');
    const player = gameState?.player;
    const mpTier = player?.mp_tier || 0;
    
    const baseTabs = [
        { id: 'strategy', label: 'æˆ°ç•¥', icon: 'âš”ï¸' },
        { id: 'finance', label: 'è²¡å‹™', icon: 'ğŸ’°' },
        { id: 'assets', label: 'è³‡ç”¢', icon: 'ğŸ­' },
        { id: 'products', label: 'å•†å“', icon: 'ğŸ“¦' }
    ];
    
    const tabs = mpTier >= 2 ? [...baseTabs, { id: 'blueprint', label: 'è—åœ–', icon: 'ğŸ¯' }] : baseTabs;
    
    return (
        <div style={{ background: 'var(--bg-card)', border: '1px solid var(--border-color)', borderRadius: '12px', padding: '20px', backdropFilter: 'blur(10px)' }}>
            <Tabs tabs={tabs} activeTab={activeTab} onChange={setActiveTab} />
            {activeTab === 'strategy' && <StrategyActions gameState={gameState} derived={derived} onAction={onAction} usedActions={usedActions} />}
            {activeTab === 'finance' && <FinanceActions gameState={gameState} derived={derived} onAction={onAction} />}
            {activeTab === 'assets' && <AssetActions gameState={gameState} derived={derived} onAction={onAction} />}
            {activeTab === 'products' && <ProductComponents.ProductDevelopmentPanel player={gameState.player} derived={derived} onAction={onAction} />}
            {activeTab === 'blueprint' && mpTier >= 2 && window.StrategyBlueprintUI && <StrategyBlueprintUI.BlueprintTabContent player={player} onAction={onAction} />}
            
            <div style={{ marginTop: '24px', paddingTop: '16px', borderTop: '1px solid var(--border-color)', textAlign: 'center' }}>
                <GlowButton variant="success" size="large" onClick={onEndTurn} icon="â¡ï¸">é€²å…¥ä¸‹ä¸€å­£</GlowButton>
            </div>
        </div>
    );
}

// ç«¶çˆ­å°æ‰‹é¢æ¿
function RivalsPanel({ rivals, playerInvestments, onInvest }) {
    const [investAmounts, setInvestAmounts] = useState({});
    return (
        <Panel title="å¸‚å ´æŠ•è³‡" icon="ğŸ¢" color="var(--accent-orange)" collapsible defaultCollapsed>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {rivals.map(rival => {
                    const invested = playerInvestments[rival.name] || 0;
                    const mpPercent = Math.min(100, (rival.mp / 1005) * 100);
                    return (
                        <div key={rival.name} style={{ display: 'flex', alignItems: 'center', gap: '12px', padding: '8px 12px', background: 'var(--bg-tertiary)', borderRadius: '6px', fontSize: '0.85rem' }}>
                            <span style={{ width: '24px' }}>{rival.icon}</span>
                            <span style={{ width: '120px', fontWeight: 600, color: 'var(--text-primary)' }}>{rival.name}</span>
                            <div style={{ flex: 1, display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{ width: '100px', height: '6px', background: 'var(--bg-secondary)', borderRadius: '3px', overflow: 'hidden' }}>
                                    <div style={{ width: `${mpPercent}%`, height: '100%', background: 'var(--accent-magenta)', borderRadius: '3px' }} />
                                </div>
                                <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-magenta)', minWidth: '50px' }}>MP {rival.mp.toFixed(0)}</span>
                            </div>
                            <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--accent-yellow)', minWidth: '80px' }}>å·²æŠ• ${invested.toFixed(0)}M</span>
                            <input type="number" value={investAmounts[rival.name] || 50} onChange={(e) => setInvestAmounts({...investAmounts, [rival.name]: parseInt(e.target.value) || 0})} 
                                style={{ width: '60px', padding: '4px 8px', background: 'var(--bg-secondary)', border: '1px solid var(--border-color)', borderRadius: '4px', color: 'var(--text-primary)', fontFamily: 'var(--font-mono)', fontSize: '0.8rem' }} />
                            <GlowButton variant="success" size="small" onClick={() => onInvest(rival.name, investAmounts[rival.name] || 50)}>+</GlowButton>
                            <GlowButton variant="danger" size="small" onClick={() => onInvest(rival.name, -(investAmounts[rival.name] || 50))} disabled={invested < (investAmounts[rival.name] || 50)}>-</GlowButton>
                        </div>
                    );
                })}
            </div>
        </Panel>
    );
}
// Doomé‡è¡¨çµ„ä»¶
function DoomGauge({ name, value, consecutive, player, rivals }) {
    const info = getDoomLabelInfo(name);
    
    // Tier2 ç©ºé–“æŒ‡æ¨™ç‰¹æ®Šè™•ç†
    const isTier2Indicator = info.isTier2 || false;
    let displayValue = value;
    let displayText = '';
    
    if (isTier2Indicator && typeof value === 'object') {
        displayValue = value.value || 0;
        displayText = value.display || '';
    }
    
    // è¨ˆç®—é¡è‰²
    let color;
    if (isTier2Indicator) {
        if (info.invert) {
            // åå‘æŒ‡æ¨™ï¼šæ•¸å€¼è¶Šé«˜è¶Šå¥½ï¼ˆä¾›é›»ç©©å®šã€ç‡Ÿé‹äººåŠ›ï¼‰
            color = displayValue >= 70 ? 'var(--accent-green)' : displayValue >= 50 ? 'var(--accent-yellow)' : 'var(--accent-red)';
        } else {
            // æ­£å‘æŒ‡æ¨™ï¼šæ•¸å€¼è¶Šä½è¶Šå¥½ï¼ˆè¨­æ–½è² è¼‰ï¼‰
            color = displayValue < 80 ? 'var(--accent-green)' : displayValue < 100 ? 'var(--accent-yellow)' : 'var(--accent-red)';
        }
    } else {
        color = getDoomColor(displayValue);
    }
    
    // è¨ˆç®—å…·é«”å±éšªå› ç´ 
    const getDangerFactors = () => {
        const factors = [];
        if (!player) return factors;
        
        if (name === 'commercial_ruin') {
            if (player.cash < 0) factors.push(`ç¾é‡‘: $${player.cash.toFixed(0)}M (è² å‚µ)`);
            if (player.debt > player.market_cap * 0.5) factors.push(`å‚µå‹™éé«˜: ${((player.debt / player.market_cap) * 100).toFixed(0)}% å¸‚å€¼`);
            const rival_avg_mc = rivals ? rivals.reduce((sum, r) => sum + (r.market_cap || 1005), 0) / rivals.length : 1000;
            if (player.market_cap < rival_avg_mc * 0.5) factors.push(`å¸‚å€¼è½å¾Œ: $${player.market_cap.toFixed(0)}M < è¡Œæ¥­å‡å€¼ 50%`);
        } else if (name === 'internal_unraveling') {
            if (player.entropy > 50) factors.push(`ç†µå€¼éé«˜: ${player.entropy.toFixed(0)}%`);
            if (player.alignment < 50) factors.push(`å°é½Šåº¦ä¸è¶³: ${player.alignment.toFixed(0)}%`);
            if (player.loyalty < 40) factors.push(`å¿ èª åº¦ä½: ${player.loyalty.toFixed(0)}%`);
        } else if (name === 'external_sanction') {
            if (player.compliance_risk > 50) factors.push(`åˆè¦é¢¨éšª: ${player.compliance_risk.toFixed(0)}%`);
            if (player.regulation > 50) factors.push(`ç›£ç®¡å£“åŠ›: ${player.regulation.toFixed(0)}%`);
        }
        return factors;
    };
    
    const dangerFactors = getDangerFactors();
    
    return (
        <div style={{ marginBottom: '12px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                <span style={{ fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <span>{info.icon}</span>
                    <span style={{ color: color }}>{info.name}</span>
                </span>
                <span style={{ fontFamily: 'var(--font-mono)', fontSize: '0.85rem', color: color }}>
                    {isTier2Indicator ? displayText : (typeof displayValue === 'number' ? displayValue.toFixed(1) + '%' : '0%')}
                    {!isTier2Indicator && displayValue >= 70 && info.threshold && <span style={{ color: 'var(--accent-red)', marginLeft: '8px' }}>({consecutive}/{info.threshold})</span>}
                </span>
            </div>
            <ProgressBar value={typeof displayValue === 'number' ? displayValue : 0} max={100} color={color} height={6} showLabel={false} />
            {!isTier2Indicator && displayValue >= 40 && dangerFactors.length > 0 && (
                <div style={{ marginTop: '4px', fontSize: '0.7rem', color: displayValue >= 70 ? 'var(--accent-red)' : 'var(--accent-yellow)' }}>
                    Ã¢Å¡ Ã¯Â¸Â {dangerFactors.join(' | ')}
                </div>
            )}
        </div>
    );
}

// çµå±€ç•«é¢
function EndingScreen({ ending, victory, player, onRestart }) {
    return (
        <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', padding: '40px 20px', textAlign: 'center' }}>
            <div style={{ fontSize: '6rem', marginBottom: '24px', animation: 'pulse-glow 2s infinite' }}>{victory ? 'ğŸ†' : 'ğŸ’€'}</div>
            <h1 style={{ fontFamily: 'var(--font-display)', fontSize: 'clamp(1.5rem, 4vw, 2.5rem)', color: victory ? 'var(--accent-green)' : 'var(--accent-red)', marginBottom: '16px' }}>{ending.type}</h1>
            <p style={{ fontSize: '1.1rem', color: 'var(--text-secondary)', maxWidth: '600px', lineHeight: 1.8, marginBottom: '32px' }}>{ending.msg}</p>
            <div style={{ background: 'var(--bg-card)', padding: '24px 32px', borderRadius: '12px', marginBottom: '32px' }}>
                <h3 style={{ color: 'var(--text-muted)', marginBottom: '16px' }}>æœ€çµ‚æ•¸æ“š</h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '24px' }}>
                    <StatValue label="Model Power" value={player.model_power} color="var(--accent-magenta)" />
                    <StatValue label="æŒçºŒå­£æ•¸" value={player.turn_count} suffix="å­£" />
                    <StatValue label="æœ€çµ‚å¸‚å€¼" value={player.market_cap} prefix="$" suffix="M" />
                </div>
            </div>
            <GlowButton variant="primary" size="large" onClick={onRestart} icon="ğŸ”„">å†ä¾†ä¸€å±€</GlowButton>
        </div>
    );
}

// ============================================
// ä¸»æ‡‰ç”¨ (ä½¿ç”¨ useGameState Hook)
// ============================================

function App() {
    // Check if all required components are loaded
    if (!window.Components || !window.Utils) {
        return React.createElement("div", {
            style: {
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                minHeight: "100vh",
                color: "var(--accent-cyan)"
            }
        }, "Loading components...");
    }
    // âœ… ä½¿ç”¨ useGameState Hook å–ä»£æ‰€æœ‰ GameEngine èª¿ç”¨
    const {
        player,
        rivals,
        globalParams,
        messages,
        ending,
        gamePhase,
        setPlayer,
        setRivals,
        setGlobalParams,
        setGamePhase,
        addMessage,
        handleAction: executeAction,
        handleEndTurn: processEndTurn,
        initializeGame,
        checkSystemStatus
    } = useGameState();
    
    
    // UI ç‰¹å®šç‹€æ…‹ï¼ˆä¸å±¬æ–¼éŠæˆ²é‚è¼¯ï¼‰
    const [currentEvent, setCurrentEvent] = useState(null);
    const [showEventModal, setShowEventModal] = useState(false);
    const [usedActions, setUsedActions] = useState({});
    const [lastTurnData, setLastTurnData] = useState({ processData: null, finances: null });
    const [unlockNotification, setUnlockNotification] = useState(null);
    const [unlockedTiers, setUnlockedTiers] = useState({});
    
    // ç³»çµ±ç‹€æ…‹æª¢æŸ¥ï¼ˆé–‹ç™¼ç”¨ï¼‰
    useEffect(() => {
        const status = checkSystemStatus;
        console.log('ğŸ® Game System Status:', status);
        
        if (!status.allReady) {
            console.warn('âš ï¸ Some engines not loaded:', 
                Object.entries(status)
                    .filter(([k, v]) => k !== 'allReady' && !v)
                    .map(([k]) => k)
            );
        }
    }, []);

    // è¨­ç½®å…¨å±€ Tier å‡ç´šå›èª¿
    useEffect(() => {
        window.onTierUpgrade = (tier) => {
            console.log(`ğŸ“¢ æ”¶åˆ° Tier ${tier} å‡ç´šé€šçŸ¥`);
        
            if (!unlockedTiers[tier]) {
                setUnlockNotification(tier);
                setUnlockedTiers(prev => ({ ...prev, [tier]: true }));
                addMessage(`ğŸ‰ è§£é– Tier ${tier} åŠŸèƒ½ï¼`, 'event');
            }
        };
    
        return () => {
            window.onTierUpgrade = null;
        };
    }, [unlockedTiers, addMessage]);    
    
    // âœ… ä½¿ç”¨ StrategyEngine è¨ˆç®—è¡ç”Ÿæ•¸æ“šï¼ˆå–ä»£ GameEngine.calculateDerivedStatsï¼‰
    const derived = useMemo(() => {
        if (!player || !window.ProcessTurnUpdates) return null;
        return window.ProcessTurnUpdates.calculateDerivedStats(player, globalParams);
    }, [player, globalParams]);


    // âœ… ä½¿ç”¨ EndingEngine è¨ˆç®— Doom Gaugeï¼ˆå–ä»£ GameEngine.calculateDoomGaugeï¼‰
    const doomGauge = useMemo(() => {
        if (!player || !rivals.length || !window.EndingEngine) {
            return { commercial_ruin: 0, internal_unraveling: 0, external_sanction: 0 };
        }
        const baseDoom = window.EndingEngine.calculateDoomGauge(player, rivals);
        
        // Tier2+ æ·»åŠ ç©ºé–“ç³»çµ±æŒ‡æ¨™
        if ((player.mp_tier || 0) >= 2 && window.SpaceEngine) {
            const tier2Indicators = window.SpaceEngine.getTier2RiskIndicators(player);
            if (tier2Indicators) {
                baseDoom.facility_capacity = tier2Indicators.facility_capacity;
                baseDoom.power_stability = tier2Indicators.power_stability;
                baseDoom.operations_staff = tier2Indicators.operations_staff;
            }
        }
        
        return baseDoom;
    }, [player, rivals]);

    
    
    // é–‹å§‹éŠæˆ²
    const handleStartGame = useCallback((name, route, rivalCount = 3) => {
        // âœ… ä½¿ç”¨ useGameState çš„ initializeGame
        const success = initializeGame(route, rivalCount);
        
        if (success) {
            // è¨­ç½®ç©å®¶åç¨±ï¼ˆå¦‚æœéœ€è¦ï¼‰
            setPlayer(prev => ({ ...prev, name }));
            addMessage(`${name} æˆç«‹ï¼é¸æ“‡è·¯ç·šï¼š${GameConfig.TECH_ROUTES[route].name}ï¼Œé¢å° ${rivalCount} ä½ç«¶çˆ­å°æ‰‹`, 'success');
        }
        
    }, [initializeGame, setPlayer, addMessage]);

    // è™•ç†è¡Œå‹•ï¼ˆåŠ ä¸Š UI å±¤çš„é™åˆ¶é‚è¼¯ï¼‰
    const handleAction = useCallback((action, params = {}) => {
        console.log("ğŸ¯ index.html handleAction:", action, params);
        if (!player) return;
        
        // æ ¸å¿ƒæˆ°ç•¥è¡Œå‹•é™åˆ¶ï¼ˆUI å±¤é‚è¼¯ï¼‰
        const coreActions = ['research', 'alignment', 'marketing', 'special'];
        if (coreActions.includes(action)) {
            if (usedActions.research || usedActions.alignment || usedActions.marketing || usedActions.special) {
                addMessage('æœ¬å­£æ ¸å¿ƒæˆ°ç•¥å·²åŸ·è¡Œï¼Œè«‹ç­‰å¾…ä¸‹å­£ï¼', 'warning');
                return;
            }
            setUsedActions(prev => ({ ...prev, [action]: true }));
        }

        // âœ… ä½¿ç”¨ useGameState çš„ handleAction
        console.log("ğŸ“¤ èª¿ç”¨ executeAction...");
        executeAction(action, params);
        console.log("ğŸ“¥ executeAction èª¿ç”¨å®Œæˆ");
        
        // è™•ç†ç‰¹æ®Šäº‹ä»¶ï¼ˆå¦‚è§£é–é€šçŸ¥ï¼‰
        // æ³¨æ„ï¼šé€™äº›é‚è¼¯æ‡‰è©²åœ¨ Engine å±¤è¿”å›ï¼Œé€™è£¡åªæ˜¯ç¤ºä¾‹
        // å¯¦éš›æ‡‰è©²å¾ executeAction çš„è¿”å›å€¼ä¸­ç²å–
        
    }, [player, usedActions, addMessage, executeAction]);

    // çµæŸå›åˆ
    const handleEndTurn = useCallback(() => {
        if (!player) return;
        
        // åŸ·è¡Œå›åˆçµç®—å‰ï¼Œå…ˆè¨ˆç®—è²¡å‹™æ•¸æ“š
        const finances = window.calculateQuarterlyFinances ? 
            window.calculateQuarterlyFinances(player, rivals, globalParams) : null;
        
        processEndTurn();
        
        // å¾ TurnUpdateEngine å–å¾—æœ€æ–°çš„ processData
        // (processEndTurn å…§éƒ¨æœƒèª¿ç”¨ handleEndTurnï¼Œçµæœå­˜åœ¨ window.__lastTurnResult)
        const lastResult = window.__lastTurnResult;
        if (lastResult?.processData || finances) {
            setLastTurnData({
                processData: lastResult?.processData || {},
                finances: finances
            });
        }
        
        setUsedActions({});
    }, [player, rivals, globalParams, processEndTurn]);

    // é‡æ–°é–‹å§‹
    const handleRestart = useCallback(() => {
        setPlayer(null);
        setRivals([]);
        setGlobalParams({ ...GameConfig.GLOBAL_PARAMS_INITIAL });
        setGamePhase('setup');
        setUnlockedTiers({});
        setUnlockNotification(null);
        setUsedActions({});
    }, [setPlayer, setRivals, setGlobalParams, setGamePhase]);

    // æŠ•è³‡ç«¶çˆ­å°æ‰‹
    const handleInvestRival = useCallback((rivalName, amount) => {
        handleAction('investRival', { rivalName, amount });
    }, [handleAction]);

    // æ¸²æŸ“éŠæˆ²éšæ®µ
    if (gamePhase === 'setup') return <StartScreen onStart={handleStartGame} />;
    if (gamePhase === 'ended' && ending) {
        return <EndingScreen 
            ending={ending} 
            victory={ending.victory || false} 
            player={player} 
            onRestart={handleRestart} 
        />;
    }

    if (gamePhase === 'playing' && player && derived) {
        const gameState = { player, globalParams, rivals, doomGauge };
        return (
            <div style={{ minHeight: '100vh', paddingBottom: '100px' }}>
                {window.DashboardUI?.GameDashboardNew ? (
                        React.createElement(window.DashboardUI.GameDashboardNew, {
                            gameState: { ...gameState, doomGauge },
                            derived: derived,
                            processData: lastTurnData.processData,
                            finances: lastTurnData.finances,
                            messages: messages
                        })
                    ) : (
                        <GameDashboard gameState={gameState} derived={derived} onAction={handleAction} />
                    )}
                <div style={{ padding: '0 16px' }}>
                    {window.RivalsUI ? React.createElement(window.RivalsUI.RivalsPanelEnhanced, {
                        rivals: rivals,
                        player: player,
                        globalParams: globalParams,
                        onInvestRival: handleInvestRival,
                        onBuyETF: (etfId, amount) => handleAction('buyETF', { etfId, amount }),
                        onSellETF: (etfId, shares) => handleAction('sellETF', { etfId, shares }),
                        disabled: false
                    }) : React.createElement(RivalsPanel, {
                        rivals: rivals,
                        playerInvestments: player.rival_investments || {},
                        onInvest: handleInvestRival
                    })}
                                    </div>
                <div style={{ padding: '16px' }}>
                    <Panel title="äº‹ä»¶æ—¥èªŒ" icon="ğŸ“†" color="var(--accent-cyan)" collapsible>
                        <MessageLog messages={messages} />
                    </Panel>
                </div>
                <div style={{ padding: '16px' }}>
                    <ActionMenu 
                        gameState={gameState} 
                        derived={derived} 
                        onAction={handleAction} 
                        onEndTurn={handleEndTurn} 
                        usedActions={usedActions} 
                    />
                </div>
                
                {/* éš¨æ©Ÿäº‹ä»¶å½ˆçª— */}
                <Modal isOpen={showEventModal} onClose={() => setShowEventModal(false)} title="éš¨æ©Ÿäº‹ä»¶">
                    {currentEvent && (
                        <div style={{ textAlign: 'center', padding: '20px' }}>
                            <div style={{ fontSize: '3rem', marginBottom: '16px' }}>
                                {currentEvent.type === 'neutral' ? 'âœ¨' : 'âš ï¸'}
                            </div>
                            <p style={{ fontSize: '1.1rem', marginBottom: '24px' }}>{currentEvent.event.desc}</p>
                            <GlowButton variant="primary" onClick={() => setShowEventModal(false)}>ç¢ºèª</GlowButton>
                        </div>)}
                </Modal>
                
                {/* åŠŸèƒ½è§£é–é€šçŸ¥ */}
                {unlockNotification && (<UnlockNotification tier={unlockNotification} onClose={() => setUnlockNotification(null)} />)}
                </div>
        );
    }
    
    return (
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', color: 'var(--accent-cyan)' }}>
            Loading...
        </div>
    );
}

// æ¸²æŸ“æ‡‰ç”¨
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>